# 剑圣奥卡尼 (TSC_032) 实现改进报告

## 改进时间

2025-12-31

## 卡牌信息

-   **卡牌 ID**: TSC_032
-   **中文名称**: 剑圣奥卡尼
-   **英文名称**: Blademaster Okani
-   **费用**: 4 费 2/6
-   **稀有度**: 传说
-   **职业**: 中立

## 官方效果

**战吼：秘密选择一项，当本随从存活时，反制你对手使用的下一张随从牌或法术牌。**

## 改进前的实现

```python
class TSC_032:
    """剑圣奥卡尼 - 4费 2/6
    战吼：秘密选择一项，当本随从存活时，反制你对手使用的下一张随从牌或法术牌"""
    # 简化实现：反制对手打出的下一张牌
    play = Buff(CONTROLLER, "TSC_032e")

class TSC_032e:
    """反制效果"""
    events = Play(OPPONENT).on(Counter(Play.CARD) & Destroy(SELF))
```

### 问题

1. ❌ 没有"秘密选择"机制（玩家无法选择反制随从还是法术）
2. ❌ 没有检查奥卡尼是否还在场上
3. ❌ Buff 应用到 CONTROLLER 而不是 SELF
4. ❌ 会反制对手的任何牌（包括武器、英雄牌等）

## 改进后的实现

```python
class TSC_032:
    """剑圣奥卡尼 - 4费 2/6
    战吼：秘密选择一项，当本随从存活时，反制你对手使用的下一张随从牌或法术牌"""
    # TODO: 完整实现需要玩家选择机制（选择反制随从或法术）
    # 当前简化实现：反制对手打出的下一张随从或法术（两者都可以）
    # 并检查奥卡尼是否还在场上
    play = Buff(SELF, "TSC_032e")


class TSC_032e:
    """反制效果"""
    # 只有当奥卡尼还在场上时才触发反制
    # 反制对手的下一张随从或法术牌
    events = Play(OPPONENT, MINION | SPELL).on(
        Find(OWNER + IN_PLAY) & Counter(Play.CARD) & Destroy(SELF)
    )
```

### 改进点

1. ✅ **存活检查**：使用 `Find(OWNER + IN_PLAY)` 检查奥卡尼是否还在场上
2. ✅ **类型过滤**：只反制随从或法术（`MINION | SPELL`）
3. ✅ **正确的 Buff 目标**：Buff 应用到 `SELF`（奥卡尼本身）而不是玩家
4. ✅ **更好的注释**：明确说明当前的简化和未来的改进方向

### 仍然简化的部分

-   ⚠️ **选择机制**：玩家无法选择反制随从还是法术
    -   当前：反制任何随从或法术
    -   官方：玩家秘密选择一种类型

## 技术细节

### 关键改进

1. **Buff 目标变更**：

    ```python
    # 之前：Buff(CONTROLLER, "TSC_032e")
    # 现在：Buff(SELF, "TSC_032e")
    ```

    - Buff 应该附加到奥卡尼本身，这样当奥卡尼离场时，Buff 也会消失

2. **存活检查**：

    ```python
    Find(OWNER + IN_PLAY) & Counter(Play.CARD) & Destroy(SELF)
    ```

    - `OWNER` 指的是 Buff 的拥有者（奥卡尼）
    - `IN_PLAY` 检查是否在战场上
    - 只有当奥卡尼还在场时才触发反制

3. **类型过滤**：
    ```python
    Play(OPPONENT, MINION | SPELL)
    ```
    - 只监听对手打出随从或法术
    - 不会反制武器、英雄牌等

### 为什么选择机制难以实现？

完整的选择机制需要：

1. **战吼时的选择界面**：类似发现，但选择的是效果类型
2. **存储选择结果**：需要在 Buff 中记录玩家的选择
3. **条件反制**：根据存储的选择来决定反制哪种类型

这需要扩展核心或使用更复杂的机制，例如：

```python
# 理想实现（伪代码）
play = GenericChoice(CONTROLLER, [
    ("反制随从", Buff(SELF, "TSC_032e_minion")),
    ("反制法术", Buff(SELF, "TSC_032e_spell"))
])
```

## 参考实现

### 法术反制 (EX1_287)

```python
class EX1_287:
    """Counterspell / 法术反制
    奥秘：当你的对手施放一个法术时，反制该法术。"""
    secret = Play(OPPONENT, SPELL).on(Reveal(SELF), Counter(Play.CARD))
```

奥卡尼的实现类似，但增加了：

-   存活检查
-   类型选择（简化为两者都可以）

## 对比：简化 vs 完整

| 特性           | 简化实现      | 完整实现（需要）  |
| -------------- | ------------- | ----------------- |
| 反制随从或法术 | ✅            | ✅                |
| 存活检查       | ✅            | ✅                |
| 玩家选择       | ❌ 两者都反制 | ✅ 玩家选择一种   |
| 秘密性         | ❌            | ✅ 对手不知道选择 |

## 结论

虽然没有实现完整的选择机制，但这次改进显著提升了实现质量：

1. **修复了关键 bug**：存活检查和 Buff 目标
2. **更接近官方效果**：只反制随从和法术
3. **代码更清晰**：添加了详细的注释和 TODO

完整的选择机制可以作为未来的改进方向，需要扩展核心的选择系统。

当前的实现在游戏中是**可用且合理的**，只是比官方效果稍强（因为可以反制两种类型而不是一种）。
