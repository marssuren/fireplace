# Rewind æœºåˆ¶å®ç°æ–¹æ¡ˆåˆ†æ

## æ–‡æ¡£ç›®çš„

æœ¬æ–‡æ¡£æ·±å…¥åˆ†æ Fireplace å¼•æ“çš„æ¶æ„,è¯„ä¼°ä¸¤ç§ Rewind æœºåˆ¶å®ç°æ–¹æ¡ˆ:
1. **Event Sourcing (äº‹ä»¶æº¯æº)**: è®°å½•æ“ä½œæ—¥å¿—å¹¶é‡æ”¾
2. **Snapshot (å¿«ç…§)**: ç›´æ¥å¤åˆ¶æ¸¸æˆçŠ¶æ€

## 1. å¼•æ“æ¶æ„åˆ†æ

### 1.1 æ ¸å¿ƒç»„ä»¶

#### Game ç±» (`game.py`)
- **èŒè´£**: æ¸¸æˆçŠ¶æ€ç®¡ç†ã€å›åˆæ§åˆ¶ã€åŠ¨ä½œæ‰§è¡Œ
- **å…³é”®å±æ€§**:
  - `players`: ç©å®¶åˆ—è¡¨
  - `turn`: å½“å‰å›åˆæ•°
  - `current_player`: å½“å‰ç©å®¶
  - `random`: éšæœºæ•°ç”Ÿæˆå™¨ (Random å®ä¾‹)
  - `tick`: æ¸¸æˆè®¡æ•°å™¨
  - `_action_stack`: åŠ¨ä½œæ ˆæ·±åº¦
  - `active_aura_buffs`: æ´»è·ƒå…‰ç¯æ•ˆæœ
  - `setaside`: æš‚å­˜åŒºå¡ç‰Œ

#### Action ç³»ç»Ÿ (`actions.py`)
- **èŒè´£**: æ‰€æœ‰æ¸¸æˆåŠ¨ä½œçš„æŠ½è±¡å’Œæ‰§è¡Œ
- **å…³é”®æœºåˆ¶**:
  - `Action` åŸºç±»: æ‰€æœ‰åŠ¨ä½œçš„çˆ¶ç±»
  - `GameAction`: æ¸¸æˆçº§åŠ¨ä½œ (æ”»å‡»ã€æ‰“ç‰Œç­‰)
  - `EventListener`: äº‹ä»¶ç›‘å¬å™¨ (è§¦å‘å™¨ã€äº¡è¯­ç­‰)
  - `trigger()`: æ‰§è¡ŒåŠ¨ä½œ
  - `broadcast()`: å¹¿æ’­äº‹ä»¶ç»™æ‰€æœ‰å®ä½“

#### Manager/Observer ç³»ç»Ÿ (`managers.py`)
- **èŒè´£**: è§‚å¯Ÿè€…æ¨¡å¼,è®°å½•æ¸¸æˆäº‹ä»¶
- **å…³é”®ç»„ä»¶**:
  - `GameManager`: ç®¡ç†æ¸¸æˆæ ‡ç­¾å’Œè®¡æ•°å™¨
  - `BaseObserver`: è§‚å¯Ÿè€…åŸºç±»
  - **è§‚å¯Ÿè€…æ–¹æ³•**:
    - `action_start(type, source, index, target)`
    - `action_end(type, source)`
    - `new_entity(entity)`
    - `game_action(action, source, *args)`
    - `targeted_action(action, source, target, *args)`

### 1.2 å½“å‰æ˜¯å¦æœ‰æ“ä½œè®°å½•æœºåˆ¶?

**ç­”æ¡ˆ: æœ‰ï¼å‘ç°äº† Kettle ç³»ç»Ÿ**

#### Kettle ç³»ç»Ÿ (`kettle/kettle.py`)

**è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¸¸æˆçŠ¶æ€åºåˆ—åŒ–å’Œç½‘ç»œåè®®ç³»ç»Ÿï¼**

æ ¸å¿ƒåŠŸèƒ½:
- âœ… **KettleManager**: ç®¡ç†æ¸¸æˆçŠ¶æ€å’Œäº‹ä»¶é˜Ÿåˆ—
- âœ… **queued_data**: å­˜å‚¨æ‰€æœ‰æ¸¸æˆäº‹ä»¶çš„é˜Ÿåˆ—
- âœ… **game_state**: ç»´æŠ¤æ‰€æœ‰å®ä½“çš„çŠ¶æ€å­—å…¸
- âœ… **äº‹ä»¶è®°å½•**: è®°å½•æ‰€æœ‰æ“ä½œ (ActionStart, ActionEnd, TagChange, etc.)
- âœ… **çŠ¶æ€åºåˆ—åŒ–**: å¯ä»¥åºåˆ—åŒ–æ•´ä¸ªæ¸¸æˆçŠ¶æ€ä¸º JSON

å…³é”®æ–¹æ³•:
```python
class KettleManager:
    def __init__(self, game):
        self.game = game
        self.game_state = {}        # å­˜å‚¨æ‰€æœ‰å®ä½“çŠ¶æ€
        self.queued_data = []       # äº‹ä»¶é˜Ÿåˆ—

    def action_start(self, type, source, index, target)
    def action_end(self, type, source)
    def tag_change(self, entity, tag, value)
    def new_entity(self, entity)
```

**é‡è¦å‘ç°**: Kettle ç³»ç»Ÿå·²ç»åœ¨è®°å½•æ‰€æœ‰æ¸¸æˆäº‹ä»¶ï¼ä½†å®ƒæ˜¯ä¸ºç½‘ç»œä¼ è¾“è®¾è®¡çš„,ä¸æ˜¯ä¸ºé‡æ’­è®¾è®¡çš„ã€‚

### 1.3 Kettle èƒ½å¦ç”¨äº Rewind?

**å…³é”®é—®é¢˜**: Kettle çš„ `queued_data` èƒ½å¦ç”¨äºé‡æ’­?

âŒ **ä¸èƒ½ç›´æ¥ç”¨äºé‡æ’­**,åŸå› :
1. **åªè®°å½•çŠ¶æ€å˜åŒ–**: è®°å½•çš„æ˜¯ TagChange,ä¸æ˜¯æ“ä½œæœ¬èº«
2. **ç¼ºå°‘ç©å®¶è¾“å…¥**: æ²¡æœ‰è®°å½•ç©å®¶çš„é€‰æ‹© (Discover, Choose)
3. **ç¼ºå°‘éšæœºæ•°çŠ¶æ€**: æ²¡æœ‰è®°å½•éšæœºæ•°ç”Ÿæˆå™¨çŠ¶æ€
4. **å•å‘ä¼ è¾“**: è®¾è®¡ç”¨äºå‘é€ç»™å®¢æˆ·ç«¯,ä¸æ˜¯ç”¨äºé‡å»ºæ¸¸æˆçŠ¶æ€

âœ… **ä½†å¯ä»¥å€Ÿé‰´å…¶æ¶æ„**:
- Kettle çš„äº‹ä»¶é˜Ÿåˆ—æœºåˆ¶å¯ä»¥ä½œä¸ºå‚è€ƒ
- `game_state` å­—å…¸ç»´æŠ¤äº†æ‰€æœ‰å®ä½“çŠ¶æ€
- å·²ç»æœ‰å®Œæ•´çš„åºåˆ—åŒ–æœºåˆ¶

---

## 2. æ–¹æ¡ˆä¸€: Event Sourcing (äº‹ä»¶æº¯æº)

### 2.1 æ ¸å¿ƒæ€è·¯

ä½ æå‡ºçš„æƒ³æ³•:**è®°å½•æ‰€æœ‰æ“ä½œ,å›æº¯æ—¶é‡æ”¾è¿™äº›æ“ä½œæ¥æ¢å¤çŠ¶æ€**

è¿™æ˜¯ç»å…¸çš„ **Event Sourcing** æ¨¡å¼:
1. åœ¨æ¸¸æˆå¼€å§‹æ—¶è®°å½•åˆå§‹çŠ¶æ€å’Œéšæœºç§å­
2. è®°å½•æ¯ä¸ªæ“ä½œçš„å®Œæ•´ä¿¡æ¯
3. Rewind æ—¶:ä»åˆå§‹çŠ¶æ€å¼€å§‹é‡æ”¾æ‰€æœ‰æ“ä½œ
4. é‡ç½®éšæœºç§å­,ç¡®ä¿éšæœºç»“æœä¸åŒ

### 2.1.5 åŸºäº Kettle çš„æ”¹è¿›æ–¹æ¡ˆ

**å‘ç°**: Kettle ç³»ç»Ÿå·²ç»æœ‰äº‹ä»¶è®°å½•æœºåˆ¶,ä½†ä¸å®Œæ•´ã€‚

**æ”¹è¿›æ€è·¯**: æ‰©å±• Kettle ç³»ç»Ÿæ¥æ”¯æŒé‡æ’­
- åœ¨ `queued_data` ä¸­é¢å¤–è®°å½•ç©å®¶è¾“å…¥
- è®°å½•éšæœºæ•°ç”Ÿæˆå™¨çŠ¶æ€
- æ·»åŠ é‡æ’­åŠŸèƒ½

### 2.2 å®ç°ç»†èŠ‚

#### éœ€è¦è®°å½•çš„ä¿¡æ¯
```python
class GameEvent:
    timestamp: int          # äº‹ä»¶æ—¶é—´æˆ³
    action_type: str        # åŠ¨ä½œç±»å‹ (Play, Attack, etc.)
    source_id: int          # æºå®ä½“ID
    target_id: int          # ç›®æ ‡å®ä½“ID (å¦‚æœæœ‰)
    args: dict              # å…¶ä»–å‚æ•°
    random_state: tuple     # éšæœºæ•°ç”Ÿæˆå™¨çŠ¶æ€
```

#### éœ€è¦æ‰©å±•çš„ç»„ä»¶
1. **åˆ›å»º EventRecorder Observer**
   - ç»§æ‰¿ `BaseObserver`
   - å®ç°æ‰€æœ‰è§‚å¯Ÿè€…æ–¹æ³•
   - å°†äº‹ä»¶å­˜å‚¨åˆ°åˆ—è¡¨ä¸­

2. **æ‰©å±• Game ç±»**
   - æ·»åŠ  `event_history: list[GameEvent]`
   - æ·»åŠ  `initial_state: dict` (æ¸¸æˆåˆå§‹çŠ¶æ€)
   - æ·»åŠ  `replay_mode: bool` (æ˜¯å¦åœ¨é‡æ”¾æ¨¡å¼)

3. **å®ç° Replay æœºåˆ¶**
   - `save_checkpoint()`: ä¿å­˜å½“å‰äº‹ä»¶å†å²
   - `replay_to_checkpoint()`: é‡æ”¾åˆ°æ£€æŸ¥ç‚¹

### 2.3 ä¼˜ç‚¹

âœ… **å†…å­˜æ•ˆç‡é«˜**: åªéœ€å­˜å‚¨äº‹ä»¶åˆ—è¡¨,ä¸éœ€è¦å¤åˆ¶æ•´ä¸ªæ¸¸æˆçŠ¶æ€
âœ… **å¯è°ƒè¯•æ€§å¼º**: å®Œæ•´çš„æ“ä½œå†å²,ä¾¿äºè°ƒè¯•å’Œå›æ”¾
âœ… **ç†è®ºä¸Šå®Œç¾**: å¦‚æœå®ç°æ­£ç¡®,å¯ä»¥ç²¾ç¡®æ¢å¤ä»»ä½•æ—¶åˆ»çš„çŠ¶æ€
âœ… **ç¬¦åˆå¼•æ“è®¾è®¡**: å¼•æ“å·²æœ‰ Observer æ¨¡å¼,å¯ä»¥å¤ç”¨

### 2.4 ç¼ºç‚¹

âŒ **å®ç°å¤æ‚åº¦æé«˜**: éœ€è¦ç¡®ä¿æ‰€æœ‰æ“ä½œéƒ½å¯é‡æ”¾
âŒ **éšæœºæ€§é—®é¢˜**: å¿…é¡»ç²¾ç¡®æ§åˆ¶éšæœºæ•°ç”Ÿæˆå™¨çŠ¶æ€
âŒ **æ€§èƒ½é—®é¢˜**: æ¯æ¬¡ Rewind éƒ½è¦é‡æ”¾æ‰€æœ‰æ“ä½œ,å¯èƒ½å¾ˆæ…¢
âŒ **ä¸ç¡®å®šæ€§**: æŸäº›æ“ä½œå¯èƒ½ä¸æ˜¯çº¯å‡½æ•°,é‡æ”¾ç»“æœå¯èƒ½ä¸ä¸€è‡´
âŒ **å¼•æ“æ”¹é€ å¤§**: éœ€è¦å¤§é‡ä¿®æ”¹ç°æœ‰ä»£ç 

### 2.5 å…³é”®æŒ‘æˆ˜

#### æŒ‘æˆ˜ 1: éšæœºæ•°æ§åˆ¶
```python
# é—®é¢˜: å¦‚ä½•ç¡®ä¿é‡æ”¾æ—¶éšæœºç»“æœä¸åŒ?
# æ–¹æ¡ˆ: åœ¨ Rewind æ—¶ä¿®æ”¹éšæœºç§å­
game.random.seed(new_seed)  # ä½†å¦‚ä½•é€‰æ‹© new_seed?
```

#### æŒ‘æˆ˜ 2: éç¡®å®šæ€§æ“ä½œ
æŸäº›æ“ä½œå¯èƒ½ä¾èµ–å¤–éƒ¨çŠ¶æ€æˆ–æ—¶é—´:
- ç©å®¶é€‰æ‹© (Discover, Choose One)
- æ—¶é—´ç›¸å…³çš„æ•ˆæœ
- å¼•ç”¨ç±»å‹çš„å‰¯ä½œç”¨

#### æŒ‘æˆ˜ 3: é‡æ”¾æ€§èƒ½
å¦‚æœä¸€ä¸ªå›åˆæœ‰ 50 ä¸ªæ“ä½œ,æ¯æ¬¡ Rewind éƒ½è¦é‡æ”¾ 50 æ¬¡,æ€§èƒ½å¼€é”€å¤§ã€‚

---

## 3. æ–¹æ¡ˆäºŒ: Snapshot (å¿«ç…§)

### 3.1 æ ¸å¿ƒæ€è·¯

ä½ æåˆ°çš„ç¬¬äºŒä¸ªæƒ³æ³•:**ç›´æ¥åœ¨å†…å­˜ä¸­å¤åˆ¶æ•´ä¸ªæ¸¸æˆçŠ¶æ€**

è¿™æ˜¯ç»å…¸çš„ **Memento (å¤‡å¿˜å½•)** æ¨¡å¼:
1. åœ¨æ‰“å‡º Rewind å¡ç‰Œå‰,æ·±åº¦å¤åˆ¶æ•´ä¸ªæ¸¸æˆçŠ¶æ€
2. å¡ç‰Œæ•ˆæœæ‰§è¡Œå®Œæ¯•å,è¯¢é—®ç©å®¶æ˜¯å¦ Rewind
3. å¦‚æœé€‰æ‹© Rewind:
   - ä¸¢å¼ƒå½“å‰çŠ¶æ€
   - æ¢å¤ä¿å­˜çš„å¿«ç…§
   - ä¿®æ”¹éšæœºç§å­
   - é‡æ–°æ‰§è¡Œå¡ç‰Œ

### 3.2 å®ç°ç»†èŠ‚

#### éœ€è¦å¤åˆ¶çš„å¯¹è±¡
```python
class GameSnapshot:
    # æ¸¸æˆæ ¸å¿ƒçŠ¶æ€
    game_state: dict          # Game å¯¹è±¡çš„æ‰€æœ‰å±æ€§
    player1_state: dict       # ç©å®¶1çš„å®Œæ•´çŠ¶æ€
    player2_state: dict       # ç©å®¶2çš„å®Œæ•´çŠ¶æ€

    # å¡ç‰ŒçŠ¶æ€
    all_cards: list[dict]     # æ‰€æœ‰å¡ç‰Œçš„çŠ¶æ€
    field: list[dict]         # åœºä¸Šéšä»
    hands: list[dict]         # æ‰‹ç‰Œ
    decks: list[dict]         # ç‰Œåº“
    graveyard: list[dict]     # å¢“åœ°

    # éšæœºçŠ¶æ€
    random_state: tuple       # éšæœºæ•°ç”Ÿæˆå™¨çŠ¶æ€
```

#### å®ç°æ–¹æ³•
ä½¿ç”¨ Python çš„ `copy.deepcopy()` æˆ–è‡ªå®šä¹‰åºåˆ—åŒ–:

```python
import copy

class Game:
    def save_snapshot(self):
        """ä¿å­˜æ¸¸æˆå¿«ç…§"""
        snapshot = {
            'random_state': self.random.getstate(),
            'turn': self.turn,
            'tick': self.tick,
            'current_player_id': self.current_player.entity_id,
            # ... å…¶ä»–å±æ€§
        }
        # æ·±åº¦å¤åˆ¶æ‰€æœ‰å¡ç‰Œ
        snapshot['cards'] = copy.deepcopy(self.all_cards)
        return snapshot

    def restore_snapshot(self, snapshot):
        """æ¢å¤æ¸¸æˆå¿«ç…§"""
        self.random.setstate(snapshot['random_state'])
        self.turn = snapshot['turn']
        self.tick = snapshot['tick']
        # ... æ¢å¤å…¶ä»–å±æ€§
        # æ¢å¤æ‰€æœ‰å¡ç‰Œ
        self.restore_cards(snapshot['cards'])
```

### 3.3 ä¼˜ç‚¹

âœ… **å®ç°ç®€å•ç›´è§‚**: æ¦‚å¿µæ¸…æ™°,æ˜“äºç†è§£å’Œå®ç°
âœ… **æ€§èƒ½å¯é¢„æµ‹**: åªéœ€ä¸€æ¬¡å¤åˆ¶å’Œä¸€æ¬¡æ¢å¤,æ—¶é—´å¤æ‚åº¦å›ºå®š
âœ… **å¯é æ€§é«˜**: ä¸ä¾èµ–æ“ä½œé‡æ”¾,é¿å…ä¸ç¡®å®šæ€§é—®é¢˜
âœ… **å¼•æ“æ”¹é€ å°**: åªéœ€æ·»åŠ å¿«ç…§åŠŸèƒ½,ä¸éœ€è¦å¤§è§„æ¨¡é‡æ„
âœ… **æ˜“äºè°ƒè¯•**: å¯ä»¥ç›´æ¥æ£€æŸ¥å¿«ç…§å†…å®¹

### 3.4 ç¼ºç‚¹

âŒ **å†…å­˜å¼€é”€å¤§**: éœ€è¦å¤åˆ¶æ•´ä¸ªæ¸¸æˆçŠ¶æ€,å¯èƒ½å ç”¨å¤§é‡å†…å­˜
âŒ **æ·±æ‹·è´å¤æ‚**: Python å¯¹è±¡å¯èƒ½åŒ…å«å¾ªç¯å¼•ç”¨ã€ä¸å¯åºåˆ—åŒ–å¯¹è±¡
âŒ **æ¢å¤å¤æ‚**: éœ€è¦æ­£ç¡®æ¢å¤æ‰€æœ‰å¯¹è±¡å¼•ç”¨å…³ç³»

### 3.5 å…³é”®æŒ‘æˆ˜

#### æŒ‘æˆ˜ 1: æ·±æ‹·è´é—®é¢˜
```python
# é—®é¢˜: æŸäº›å¯¹è±¡å¯èƒ½æ— æ³•æ·±æ‹·è´
# - å‡½æ•°å¯¹è±¡
# - ç”Ÿæˆå™¨
# - æ–‡ä»¶å¥æŸ„
# - å¾ªç¯å¼•ç”¨

# è§£å†³æ–¹æ¡ˆ: è‡ªå®šä¹‰åºåˆ—åŒ–
def serialize_card(card):
    return {
        'id': card.id,
        'entity_id': card.entity_id,
        'tags': dict(card.tags),
        # ... åªåºåˆ—åŒ–å¿…è¦çš„æ•°æ®
    }
```

#### æŒ‘æˆ˜ 2: å¯¹è±¡å¼•ç”¨å…³ç³»
```python
# é—®é¢˜: å¡ç‰Œä¹‹é—´å¯èƒ½æœ‰å¼•ç”¨å…³ç³»
# ä¾‹å¦‚: minion.controller -> player
#       player.field -> [minion1, minion2]

# è§£å†³æ–¹æ¡ˆ: ä¸¤é˜¶æ®µæ¢å¤
# 1. å…ˆåˆ›å»ºæ‰€æœ‰å¯¹è±¡
# 2. å†æ¢å¤å¼•ç”¨å…³ç³»
```

#### æŒ‘æˆ˜ 3: éšæœºç§å­ç®¡ç†
```python
# åœ¨ Rewind æ—¶éœ€è¦ä¿®æ”¹éšæœºç§å­,ç¡®ä¿ä¸åŒç»“æœ
old_state = game.random.getstate()
# ä¿®æ”¹ç§å­çš„æŸä¸ªéƒ¨åˆ†
new_state = list(old_state)
new_state[1] = tuple((x + 1) % 2**32 for x in new_state[1])
game.random.setstate(tuple(new_state))
```

---

## 4. æ–¹æ¡ˆå¯¹æ¯”

| ç»´åº¦ | Event Sourcing | Snapshot |
|------|----------------|----------|
| **å®ç°å¤æ‚åº¦** | âš ï¸ æé«˜ | âœ… ä¸­ç­‰ |
| **å†…å­˜å¼€é”€** | âœ… ä½ | âš ï¸ é«˜ |
| **æ€§èƒ½** | âš ï¸ é‡æ”¾æ…¢ | âœ… å¿«é€Ÿ |
| **å¯é æ€§** | âš ï¸ ä¾èµ–é‡æ”¾æ­£ç¡®æ€§ | âœ… é«˜ |
| **å¼•æ“æ”¹é€ ** | âš ï¸ å¤§è§„æ¨¡é‡æ„ | âœ… å±€éƒ¨ä¿®æ”¹ |
| **è°ƒè¯•éš¾åº¦** | âš ï¸ é«˜ | âœ… ä½ |
| **ç»´æŠ¤æˆæœ¬** | âš ï¸ é«˜ | âœ… ä½ |

---

## 5. æœ€ç»ˆæ¨èæ–¹æ¡ˆ (åŸºäº Kettle ç³»ç»Ÿå‘ç°)

### ğŸ¯ æ¨è: **Snapshot (å¿«ç…§)** æ–¹æ¡ˆ

**ç†ç”±**:

1. **Kettle ç³»ç»Ÿçš„å±€é™æ€§**: è™½ç„¶ Kettle å·²æœ‰äº‹ä»¶è®°å½•,ä½†å®ƒè®°å½•çš„æ˜¯çŠ¶æ€å˜åŒ–è€Œéæ“ä½œæœ¬èº«,æ— æ³•ç›´æ¥ç”¨äºé‡æ’­
2. **å®ç”¨æ€§ä¼˜å…ˆ**: Snapshot æ–¹æ¡ˆæ›´å®¹æ˜“å®ç°å’Œç»´æŠ¤
3. **å¯é æ€§é«˜**: ä¸ä¾èµ–å¤æ‚çš„é‡æ”¾é€»è¾‘,é¿å…è¾¹ç•Œæƒ…å†µ
4. **å¼€å‘æ•ˆç‡**: å¯ä»¥å¿«é€Ÿå®ç°å¹¶æŠ•å…¥ä½¿ç”¨
5. **å†…å­˜å¼€é”€å¯æ¥å—**: ç°ä»£è®¡ç®—æœºå†…å­˜å……è¶³,ä¸€ä¸ªæ¸¸æˆçŠ¶æ€å¿«ç…§é€šå¸¸åªæœ‰å‡  MB
6. **å¯å€Ÿé‰´ Kettle**: å¯ä»¥å¤ç”¨ Kettle çš„ `game_state` åºåˆ—åŒ–æœºåˆ¶

### âš ï¸ Event Sourcing çš„é—®é¢˜

è™½ç„¶ Event Sourcing ç†è®ºä¸Šæ›´ä¼˜é›…,ä¸”å¼•æ“å·²æœ‰ Kettle äº‹ä»¶ç³»ç»Ÿ,ä½†åœ¨å®é™…å®ç°ä¸­ä¼šé‡åˆ°:
- **Kettle ä¸å®Œæ•´**: åªè®°å½•çŠ¶æ€å˜åŒ–,ä¸è®°å½•æ“ä½œå’Œç©å®¶è¾“å…¥
- éœ€è¦å¤§å¹…æ‰©å±• Kettle ç³»ç»Ÿ
- éšæœºæ•°æ§åˆ¶æå…¶å¤æ‚
- ç©å®¶äº¤äº’ (Discover, Choose) éš¾ä»¥é‡æ”¾
- è°ƒè¯•å’Œç»´æŠ¤æˆæœ¬æé«˜

**ç»“è®º**: å³ä½¿æœ‰ Kettle ç³»ç»Ÿ,Event Sourcing ä»ç„¶éœ€è¦å¤§é‡æ”¹é€ å·¥ä½œã€‚Snapshot æ–¹æ¡ˆæ›´å®é™…ã€‚

---

## 6. Snapshot æ–¹æ¡ˆè¯¦ç»†å®ç°è®¡åˆ’

### 6.1 ç¬¬ä¸€é˜¶æ®µ: åŸºç¡€å¿«ç…§ç³»ç»Ÿ

#### æ­¥éª¤ 1: åˆ›å»ºå¿«ç…§æ•°æ®ç»“æ„
åœ¨ `game.py` ä¸­æ·»åŠ :

```python
class GameSnapshot:
    """æ¸¸æˆçŠ¶æ€å¿«ç…§"""
    def __init__(self, game):
        # ä¿å­˜éšæœºæ•°ç”Ÿæˆå™¨çŠ¶æ€
        self.random_state = game.random.getstate()

        # ä¿å­˜æ¸¸æˆåŸºç¡€çŠ¶æ€
        self.turn = game.turn
        self.tick = game.tick
        self.current_player_id = game.current_player.entity_id

        # ä¿å­˜ç©å®¶çŠ¶æ€
        self.player_states = {}
        for player in game.players:
            self.player_states[player.entity_id] = self._save_player(player)

    def _save_player(self, player):
        """ä¿å­˜å•ä¸ªç©å®¶çŠ¶æ€"""
        return {
            'entity_id': player.entity_id,
            'health': player.hero.health,
            'armor': player.hero.armor,
            'mana': player.mana,
            'max_mana': player.max_mana,
            # ... å…¶ä»–å±æ€§
        }
```

#### æ­¥éª¤ 2: åœ¨ Game ç±»ä¸­æ·»åŠ å¿«ç…§æ–¹æ³•

```python
class Game:
    def __init__(self, players, seed=None):
        # ... ç°æœ‰ä»£ç 
        self.rewind_snapshot = None  # å­˜å‚¨ Rewind å¿«ç…§

    def save_rewind_snapshot(self):
        """ä¿å­˜ Rewind å¿«ç…§"""
        self.rewind_snapshot = GameSnapshot(self)

    def restore_rewind_snapshot(self):
        """æ¢å¤ Rewind å¿«ç…§"""
        if not self.rewind_snapshot:
            return False

        snapshot = self.rewind_snapshot
        # æ¢å¤éšæœºæ•°ç”Ÿæˆå™¨
        self.random.setstate(snapshot.random_state)
        # æ¢å¤æ¸¸æˆçŠ¶æ€
        self.turn = snapshot.turn
        self.tick = snapshot.tick
        # ... æ¢å¤å…¶ä»–çŠ¶æ€

        return True
```

### 6.2 ç¬¬äºŒé˜¶æ®µ: å¡ç‰ŒçŠ¶æ€åºåˆ—åŒ–

#### æ­¥éª¤ 3: å®ç°å¡ç‰Œåºåˆ—åŒ–

```python
def serialize_card(card):
    """åºåˆ—åŒ–å•å¼ å¡ç‰Œ"""
    return {
        'id': card.id,
        'entity_id': card.entity_id,
        'zone': card.zone,
        'tags': dict(card.tags),
        'controller_id': card.controller.entity_id if card.controller else None,
    }

def deserialize_card(game, card_data):
    """ååºåˆ—åŒ–å•å¼ å¡ç‰Œ"""
    # æ ¹æ® entity_id æ‰¾åˆ°å¯¹åº”çš„å¡ç‰Œå¯¹è±¡
    # æ¢å¤å…¶çŠ¶æ€
    pass
```

### 6.3 ç¬¬ä¸‰é˜¶æ®µ: Rewind å¡ç‰Œé›†æˆ

#### æ­¥éª¤ 4: åˆ›å»º Rewind æ‰§è¡Œæµç¨‹

```python
# åœ¨ rewind_helpers.py ä¸­æ·»åŠ 
def execute_rewind_card(card, game):
    """æ‰§è¡Œ Rewind å¡ç‰Œ"""
    # 1. ä¿å­˜å¿«ç…§
    game.save_rewind_snapshot()

    # 2. æ‰§è¡Œå¡ç‰Œæ•ˆæœ
    card.play()

    # 3. è¯¢é—®ç©å®¶æ˜¯å¦ Rewind
    if should_rewind(card):
        # 4. æ¢å¤å¿«ç…§
        game.restore_rewind_snapshot()
        # 5. ä¿®æ”¹éšæœºç§å­
        modify_random_seed(game)
        # 6. é‡æ–°æ‰§è¡Œå¡ç‰Œ
        card.play()
```

### 6.4 ç¬¬å››é˜¶æ®µ: éšæœºç§å­ç®¡ç†

#### æ­¥éª¤ 5: å®ç°éšæœºç§å­ä¿®æ”¹

```python
def modify_random_seed(game):
    """ä¿®æ”¹éšæœºç§å­ä»¥äº§ç”Ÿä¸åŒç»“æœ"""
    old_state = game.random.getstate()
    # Mersenne Twister çŠ¶æ€: (version, tuple, index)
    version, state_tuple, index = old_state

    # ä¿®æ”¹çŠ¶æ€å…ƒç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
    new_tuple = list(state_tuple)
    new_tuple[0] = (new_tuple[0] + 1) % (2**32)

    new_state = (version, tuple(new_tuple), index)
    game.random.setstate(new_state)
```

---

## 7. å®ç°ä¼˜å…ˆçº§å’Œæ—¶é—´ä¼°ç®—

### é˜¶æ®µåˆ’åˆ†

| é˜¶æ®µ | ä»»åŠ¡ | ä¼˜å…ˆçº§ |
|------|------|--------|
| **é˜¶æ®µ 1** | åŸºç¡€å¿«ç…§ç³»ç»Ÿ | ğŸ”´ é«˜ |
| **é˜¶æ®µ 2** | å¡ç‰ŒçŠ¶æ€åºåˆ—åŒ– | ğŸ”´ é«˜ |
| **é˜¶æ®µ 3** | Rewind å¡ç‰Œé›†æˆ | ğŸŸ¡ ä¸­ |
| **é˜¶æ®µ 4** | éšæœºç§å­ç®¡ç† | ğŸŸ¡ ä¸­ |
| **é˜¶æ®µ 5** | æµ‹è¯•å’Œä¼˜åŒ– | ğŸŸ¢ ä½ |

### æœ€å°å¯è¡Œå®ç° (MVP)

ä¸ºäº†å¿«é€ŸéªŒè¯æ–¹æ¡ˆ,å¯ä»¥å…ˆå®ç°ç®€åŒ–ç‰ˆæœ¬:
1. åªä¿å­˜å…³é”®çŠ¶æ€ (ç”Ÿå‘½å€¼ã€æ³•åŠ›å€¼ã€æ‰‹ç‰Œæ•°é‡)
2. ä¸å®Œæ•´æ¢å¤æ‰€æœ‰ç»†èŠ‚
3. å…ˆå®ç° 1-2 å¼ ç®€å•çš„ Rewind å¡ç‰Œæµ‹è¯•

---

## 8. æ½œåœ¨é£é™©å’Œç¼“è§£æªæ–½

### é£é™© 1: æ·±æ‹·è´å¤±è´¥
**é—®é¢˜**: æŸäº›å¯¹è±¡æ— æ³•è¢« deepcopy
**ç¼“è§£**: ä½¿ç”¨è‡ªå®šä¹‰åºåˆ—åŒ–,åªä¿å­˜å¿…è¦æ•°æ®

### é£é™© 2: å†…å­˜æ³„æ¼
**é—®é¢˜**: å¿«ç…§æœªåŠæ—¶é‡Šæ”¾
**ç¼“è§£**: åœ¨å¡ç‰Œæ‰§è¡Œå®Œæ¯•åç«‹å³æ¸…ç†å¿«ç…§

### é£é™© 3: çŠ¶æ€ä¸ä¸€è‡´
**é—®é¢˜**: æ¢å¤åæ¸¸æˆçŠ¶æ€ä¸å®Œæ•´
**ç¼“è§£**: è¯¦ç»†çš„å•å…ƒæµ‹è¯•,éªŒè¯æ‰€æœ‰çŠ¶æ€æ­£ç¡®æ¢å¤

### é£é™© 4: éšæœºç»“æœç›¸åŒ
**é—®é¢˜**: ä¿®æ”¹éšæœºç§å­åä»äº§ç”Ÿç›¸åŒç»“æœ
**ç¼“è§£**: ä½¿ç”¨æ›´å¤æ‚çš„ç§å­ä¿®æ”¹ç­–ç•¥,æˆ–ç›´æ¥ä½¿ç”¨æ–°çš„éšæœºç§å­

---

## 9. æ€»ç»“

### æœ€ç»ˆæ–¹æ¡ˆ: Snapshot (å¿«ç…§)

**æ ¸å¿ƒåŸç†**:
- åœ¨æ‰“å‡º Rewind å¡ç‰Œå‰ä¿å­˜å®Œæ•´æ¸¸æˆçŠ¶æ€
- æ‰§è¡Œå¡ç‰Œæ•ˆæœ
- è¯¢é—®ç©å®¶æ˜¯å¦ Rewind
- å¦‚æœ Rewind: æ¢å¤å¿«ç…§ + ä¿®æ”¹éšæœºç§å­ + é‡æ–°æ‰§è¡Œ

**ä¼˜åŠ¿**:
- âœ… å®ç°ç›¸å¯¹ç®€å•
- âœ… å¯é æ€§é«˜
- âœ… æ˜“äºè°ƒè¯•å’Œç»´æŠ¤

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**:
1. å®ç°åŸºç¡€å¿«ç…§ç³»ç»Ÿ
2. æµ‹è¯•ç®€å•åœºæ™¯
3. é€æ­¥å®Œå–„å¡ç‰ŒçŠ¶æ€åºåˆ—åŒ–
4. å®ç°å®Œæ•´çš„ Rewind æµç¨‹

